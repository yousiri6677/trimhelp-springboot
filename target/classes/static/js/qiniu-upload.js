!function(n){function s(n,e){for(var t in n)e(t,n[t])}function e(n){var e,t,o,i,a,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,s=0,c="",f=[];if(!n)return n;for(n=function l(n){if(null==n)return"";var e,t,o,i=n+"",a="";e=t=0,o=i.length;for(var r=0;r<o;r++){var u=i.charCodeAt(r),s=null;if(u<128)t++;else if(127<u&&u<2048)s=String.fromCharCode(u>>6|192,63&u|128);else if(63488&u^!0)s=String.fromCharCode(u>>12|224,u>>6&63|128,63&u|128);else{if(64512&u^!0)throw new RangeError("Unmatched trail surrogate at "+r);var c=i.charCodeAt(++r);if(64512&c^!0)throw new RangeError("Unmatched lead surrogate at "+(r-1));u=((1023&u)<<10)+(1023&c)+65536,s=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,63&u|128)}null!==s&&(e<t&&(a+=i.slice(e,t)),a+=s,e=t=r+1)}return e<t&&(a+=i.slice(e,o)),a}(n+"");e=(a=n.charCodeAt(u++)<<16|n.charCodeAt(u++)<<8|n.charCodeAt(u++))>>18&63,t=a>>12&63,o=a>>6&63,i=63&a,f[s++]=r.charAt(e)+r.charAt(t)+r.charAt(o)+r.charAt(i),u<n.length;);switch(c=f.join(""),n.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c}function c(n){return(n=e(n)).replace(/\//g,"_").replace(/\+/g,"-")}var f=0,l={};function m(e,o,i){var n=Math.ceil(f/o.chunk_size),t=Math.ceil(e.size/o.chunk_size),a=Math.min(o.chunk_size,e.size-f),r=e.slice(f,f+a),u={chunk:n,chunks:t,name:e.uniqueName};s(u,function(n,e){o.multi_parmas[n]=e}),o.filesize=e.size,o.headers={"Content-Type":"application/octet-stream"},o.isChunk=!0,h(r,o,{onCompleted:function(n){(f+=a,l[e.uniqueName]=l[e.uniqueName]||[],l[e.uniqueName].push(n.ctx),f<e.size)?n.ctx?m(e,o,i):(f=0,delete l[e.uniqueName]):(f=0,delete o.isChunk,delete o.headers["Content-Type"],s(u,function(n,e){delete o.multi_parmas[n]}),function r(e,n,t){var o="/key/"+c(e.filename),i="/fname/"+c(e.filename),a={domain:n.domain+"/mkfile/"+e.size+o+i,method:"POST",headers:{"Content-Type":"application/octet-stream"},multi_parmas:n.multi_parmas,support_options:!0,stream:!0};h(e.ctx,a,{onCompleted:function(n){n.filename=e.filename,n.name=e.name,t.onCompleted(n)},onError:function(){throw new Error("qiniu uploadChunk error")},onProgress:function(n,e){},onOpen:function(n){t.onOpen(n)}})}({ctx:l[e.uniqueName].join(","),name:e.name,size:e.size,filename:e.uniqueName},o,i))},onError:function(){throw new Error("qiniu uploadChunk error")},onProgress:function(n,e){var t=n+f;i.onProgress(t,o.filesize)},onOpen:function(n){i.onOpen(n)}})}function h(n,e,t){var o=new XMLHttpRequest;o.upload&&e.support_options&&(o.upload.onprogress=function(n){t.onProgress(n.loaded,n.total)}),o.onreadystatechange=function(){if(4==o.readyState){var n=o.responseText||"{}";(n=JSON.parse(n)).filename=e.unique_value,t.onCompleted(n)}};var i=e.domain;e.isChunk&&(i=function a(n,e){var t="";return s(e,function(n,e){"token"!=n&&(t+=(t?"&":"")+encodeURIComponent(n)+"="+encodeURIComponent(e))}),t&&(n+=(0<n.indexOf("?")?"&":"?")+t),n}(i+="/mkblk/"+n.size,e.multi_parmas)),o.open(e.method,i,!0),t.onOpen(o),e.stream&&o.setRequestHeader("authorization","UpToken "+e.multi_parmas.token),s(e.headers,function(n,e){o.setRequestHeader(n,e)}),o.send(n)}var i=function y(n,e,t){if(n.size&&e.chunk_size<n.size){var o=e.genUId(n);o+=n.name.substr(n.name.lastIndexOf(".")),n.uniqueName=o,e.stream=!0,m(n,e,t)}else{h(e.data(n,e),e,t)}},a={form:function q(n,e){var t=new FormData;if(e.unique_key){var o=n.name.substr(n.name.lastIndexOf(".")),i=r()+o;t.append(e.unique_key,i),e.unique_value=i}return t.append(e.file_data_name,n),u(e.multi_parmas,function(n,e){t.append(n,e)}),t},json:function T(n,e){var t={};if(e.unique_key){var o=n.name.substr(n.name.lastIndexOf(".")),i=r()+o;t[e.unique_key]=i,e.unique_value=i}return t[e.file_data_name]=n,u(e.multi_parmas,function(n,e){t[n]=e}),JSON.stringify(t)},data:function z(n,e){return n}},t={domain:"https://upload.qiniu.com",fileType:RongIMLib.FileType.IMAGE,getToken:function(e){RongIMClient.getInstance().getFileToken(this.fileType,{onSuccess:function(n){e(n.token)},onError:function(n){console.log("获取上传token失败"),console.log(n)}})}};function r(){var t=(new Date).getTime();return"xxxxxx4xxxyxxxxxxx".replace(/[xy]/g,function(n){var e=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==n?e:3&e|8).toString(16)})}function u(n,e){for(var t in n)e(t,n[t])}function o(n){this.options=function o(n){var e={domain:"",method:"POST",file_data_name:"file",unique_key:"key",base64_size:4194304,chunk_size:4194304,headers:{},multi_parmas:{},query:{},support_options:!0,data:a.form,genUId:r};if(!n||!n.domain)throw new Error("domain is null");for(var t in n)e[t]=n[t];return e}(n),this.setOptions=function(n){var t=this;u(n,function(n,e){t.options[n]=e})},this.upload=function(n,t){if(n){var e=this;i(n,this.options,{onProgress:function(n,e){t.onProgress(n,e)},onCompleted:function(n){t.onCompleted(n)},onError:function(n){t.onError(n)},onOpen:function(n){e.xhr=n}})}else t.onError("upload file is null.")},this.cancel=function(){this.xhr&&this.xhr.abort()}}function p(n){return new o(n)}function d(i,a,r){var u=document.createElement("canvas"),s=u.getContext("2d"),c=new Image;c.onload=function(){var n=function(n,e,t){var o,i,a,r=n<e,u=0,s=0;return(r?e/n:n/e)>t.scale?r?s=((a=e/(o=n/(i=100)))-t.maxHeight)/2:u=((i=n/(o=e/(a=100)))-t.maxWidth)/2:r?(o=e/t.maxHeight,a=t.maxHeight,i=n/o):(o=n/t.maxWidth,i=t.maxWidth,a=e/o),{w:i,h:a,x:-u,y:-s}}(c.width,c.height,a);u.width=n.w>a.maxWidth?a.maxWidth:n.w,u.height=n.h>a.maxHeight?a.maxHeight:n.h,s.drawImage(c,n.x,n.y,n.w,n.h);try{var e=u.toDataURL(i.type,a.quality),t=new RegExp("^data:image/[^;]+;base64,");e=e.replace(t,""),r(e)}catch(o){throw new Error(o)}},c.src="string"==typeof i?"data:image/jpg;base64,"+i:function(n){var e=window.URL||window.webkitURL;return e?e.createObjectURL(n):""}(i)}function g(n,e){var t=n.file,o=n.compress;d(t,o,e)}_init=function(t,o){if(t.getToken)t.getToken(function(n){t.multi_parmas||(t.multi_parmas={}),t.multi_parmas.token=n,t.headers||(t.headers={}),t.base64&&(t.headers["Content-type"]="application/octet-stream",t.headers.Authorization="UpToken "+n);var e=p(t);o(e)});else{t.headers||(t.headers={}),t.base64&&(t.headers["Content-type"]="application/octet-stream");var n=p(t);o(n)}};function v(t,n,o){n.upload(t.file,{onError:function(n){o.onError(n)},onProgress:function(n,e){o.onProgress(n,e)},onCompleted:function(e){e.filename||(e.filename=e.hash);var n=t.compressThumbnail||g;t.compress?n(t,function(n){e.thumbnail=n,o.onCompleted(e)}):o.onCompleted(e)}})}function x(n){var t=this;this.instance=n,this.upload=function(n,e){v({file:n},t.instance,e)},this.cancel=function(){t.instance.cancel()}}function C(n,e){var o=this;this.cfg=e,this.instance=n,this.upload=function(n,e){var t={file:n,compress:o.cfg};v(t,o.instance,e)},this.cancel=function(){o.instance.cancel()}}function _(o,i){_init(o,function(n){var e={maxHeight:o.height||240,maxWidth:o.width||240,quality:o.quality||.5,scale:o.scale||2.4},t=new C(n,e);i(t)})}var k=function(e,n,t){!function(n,t){_init(n,function(n){var e=new x(n);t(e)})}(n,function(n){n.upload(e,t)})},w=function(e,n,t){_(n,function(n){n.upload(e,t)})};n.imageStartUpload=function(n,e){w(n,t,{onError:function(n){console.log(n)},onProgress:function(n,e){},onCompleted:function(n){n.fileType="image",e(n)}})},n.fileStartUpload=function(n,e){t.fileType=RongIMLib.FileType.FILE,k(n,t,{onError:function(n){console.log(n)},onProgress:function(n,e){},onCompleted:function(n){n.fileType="file",e(n)}})},n.fileConfig=t}(RCS);